# **机械臂分控程序 - 更新日志**

## 版本: v2.0 (重构与功能增强版)

日期: 2025年8月7日

更新摘要:

本次更新对项目进行了大规模的功能增强、代码重构和问题修复。核心是解决了CyberGear舵机转动准确度和速度的问题，并在此基础上重构了运动控制函数，实现了高精度的同步移动和梯形速度规划。同时，对项目结构进行了模块化拆分，大幅提升了代码的可读性、可维护性和稳定性。

#### **I. 主要功能增强与新增函数**

1. **新增混合模式控制函数 (`Move_and_Hold_Hybrid_V2`)**:
   - 创建了一个高级控制序列，该序列使用高精度的“运控模式”执行移动，完成后自动切换到低开销的“位置模式”进行位置保持。
   - 支持根据负载情况（带载/空载）选择不同的增益参数档案。
2. **全面升级高精度移动函数 (`MiAngleControl_MultiStage_V3`)**:
   - **增加了可切换的增益档案**: 可在函数调用时方便地选择“带载”或“空载”两套不同的PID参数，以适应不同工况。
   - **增加了超时保护**: 新增可选的超时功能，防止程序在电机堵转等异常情况下无限等待。
   - **参数化退出条件**: 将退出循环的位置误差和速度误差变为可配置的传入参数，使函数能同时满足粗略定位和精确定位的需求。
   - **增加了电机指针参数**: 解除了函数与特定电机 `mi_motor[0]` 的硬编码绑定，使其可以控制任意电机实例。

#### **II. 核心问题修复与稳定性提升**

1. **解决了电机角度不实时更新的根本问题**:
   - 通过调试器和协议分析，最终确认电机通信为“请求-应答”模式，而非连续上报。
   - 在所有同步等待函数中，都加入了在循环内持续发送指令的**主动轮询（Polling）机制**，从而成功获取了运动过程中的实时角度反馈。
2. **提升了串口通信的健壮性**:
   - 重构了`main.c`中的指令接收逻辑，使用**指令队列（环形缓冲区）**代替了简单的全局标志位，避免了在高并发下指令丢失的问题。
   - 增强了指令解析逻辑，使其能同时正确处理带参数（如`f90`）和不带参数（如`s`）的指令。
   - 解决了STM32向PC发送`printf`浮点数时出现乱码的问题，指出了需要在IDE中**开启浮点数支持**的编译选项。
   - 通过增加**临界区保护 (`__disable_irq`)**，修复了主程序读取`Motor->Angle`等变量时，可能被CAN中断打断而导致“数据撕裂”的风险。

#### **III. 代码重构与结构优化**

1. **项目模块化**:
   - 创建了 `CyberGear_Control.c/.h` 文件，将所有与CyberGear舵机相关的应用层控制逻辑（如梯形规划、混合模式等）从`main.c`和`cybergear.c`中分离出来，使驱动层和应用层解耦。
   - 创建了 `Stepper_and_Gripper.c/.h` 文件，将所有步进电机和夹爪舵机的控制逻辑从`main.c`中分离出来，形成了独立的升降抓取模块。
2. **代码规范化**:
   - 在`Stepper_and_Gripper`模块中，将所有“魔法数字”（如PWM值、延时、物理转换系数）替换为了在头文件中**宏定义 (`#define`) 的命名常量**，使参数意义一目了然，便于集中修改。
   - 为所有重构和新增的函数添加了符合Doxygen规范的**中文注释**，详细说明了函数功能、参数意义和返回值。
   - 对`main.c`中的初始化代码块进行了格式化和分段注释，提升了可读性。
   - 将`last_angle`等状态变量封装进了对应的控制模块内部，降低了`main.c`中全局变量的耦合度。

## v3_0813

修改数据接收处理部分，修复了解析失败主控数据的问题

## v4_0814

莫名其妙的上电乱转，废弃了，不知道为什么

## v5_0814

对MiAngleControl_MultiStage_V3函数引入动态超时CyberGear_EstimateTimeoutMs

用于一次函数拟合的实测数据（参数：位置容忍度1.5度，速度容忍度3.0度/秒）：

|       | 带载   | 不带载    |
| ----- | ------ | --------- |
| 90度  | 1.6秒  | 0.6-0.8秒 |
| 180度 | 2.25秒 | 1.0秒     |

## v6_0818_0818

大更新，升降电机从步进改成小米

时间相关数据如下：

| 指令 (Command) | 实测耗时 (Actual Time) | 代码逻辑最大超时 (Max Timeout from Code Logic) | 分析 (Analysis)                                              |
| -------------- | ---------------------- | ---------------------------------------------- | ------------------------------------------------------------ |
| **`s`**        | **1.102 秒**           | **1.350 秒**                                   | `s`指令让机械臂从0cm上升到45cm。实测时间在最大超时范围内，非常合理。 |
| **`g12`**      | **2.718 秒**           | **3.227 秒**                                   | `get`动作包含两次升降和两次夹爪动作。理论计算值为各阶段最大超时之和，实测值符合预期。 |
| **`p12`**      | **2.236 秒**           | **2.800 秒**                                   | `place`动作同样包含两次升降和一次夹爪动作。理论计算值提供了约500ms的安全缓冲，完全正常。 |

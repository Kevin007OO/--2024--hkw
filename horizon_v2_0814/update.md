# 水平移动滑台更新日志

## v1_0813

#### 更新内容概述

本次更新主要围绕串口数据接收的鲁棒性提升、控制循环移植到定时器中断以及 CAN 发送阻塞风险优化展开。

------

### 1. 串口接收处理优化

- **新增基本长度检查**
   在 `HAL_UARTEx_RxEventCallback` 中添加 `Size < 2` 判断，过滤掉无效或长度不足的数据包，避免误触发控制逻辑。
- **安全字符串结束符处理**
   接收到的数据包末尾统一添加 `\0` 结束符，防止 `atof` 读取缓冲区外的残留数据，消除越界风险。
- **指令合法性验证**
   仅当首字节命令为 `'A'` 时才解析参数，其他数据包直接忽略，有效防止干扰数据引发异常动作。
- **保持接收循环**
   在回调末尾重启 `HAL_UARTEx_ReceiveToIdle_DMA`，保证串口始终处于接收状态，并禁用半传输中断。

------

### 2. 控制循环迁移到定时器中断

- 将原本 `while(1)` 主循环中的电机控制、PID 更新、CAN 发送逻辑迁移到 `TIM1` 定时器中断（`HAL_TIM_PeriodElapsedCallback`）中执行。
- 定时器周期由 `TIM1` 配置确定，保证控制循环的执行频率稳定，不再依赖 `HAL_Delay`。
- 主循环仅保留非实时任务（如指令标志位检测），实时控制完全由中断驱动。

------

### 3. CAN 发送阻塞风险优化

- 在中断中的 CAN 发送前加入**超时等待机制**：
   若 `HAL_CAN_GetTxMailboxesFreeLevel` 在 3ms 内未释放发送邮箱，则跳过本次发送，避免 CAN 拥塞导致中断长时间阻塞。

------

### 4. 其他改动

- 关键全局变量（`ref`, `rx_done`, `tx_once_flag`）添加 `volatile` 修饰，确保在中断与主循环之间数据一致性。
- 保留 `M2006_done()` 检查逻辑，保持到位检测与 UART 反馈功能不变。

------

### 预期效果

1. **接收更稳**：容错性提高，能正确过滤无效数据，防止乱码或干扰包触发动作。
2. **周期更稳定**：定时器中断驱动控制循环，响应时间可控且均匀。
3. **防卡死**：CAN 发送加入超时保护，降低系统卡住的风险。
4. **代码更清晰**：主循环职责单一，中断专注实时控制，模块分工明确。

## v2_0814

1. 放在中断中测试失败了，所以放回主循环
2. 其他改动保留上次V1版本的
3. UART通信优化：波特率改为9600，停止位改为2，GPIO输出速度改为medium，反馈信息改为0xAA，增加接收错误处理防止接收卡死